<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AllSportsLocal - Jedan Teren</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #000; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }

        .map-overlay {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.85); color: white;
            padding: 12px 25px; border-radius: 30px; font-size: 0.9rem;
            text-align: center; width: 70%; border: 1px solid #444;
            pointer-events: none;
        }

        /* Stil za popup na mapi */
        .leaflet-popup-content { font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <div class="map-overlay">Dodirni mapu da postaviš svoj teren. Nova lokacija će zameniti staru.</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyyqnqeS-9jurBX-6VIRp8CiPTMbXkXgw",
            databaseURL: "https://allsportslocal-ea1d4-default-rtdb.europe-west1.firebasedatabase.app/",
            appId: "1:161980114353:web:f8deefef0d5d85b1cc8990"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Inicijalizacija satelitske mape
        var map = L.map('map', { zoomControl: false }).setView([44.8, 20.4], 7);
        L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Dobavljanje ID-a telefona iz lokalne memorije
        let myPhoneId = localStorage.getItem('myPhoneId');
        if (!myPhoneId) {
            myPhoneId = 'dev_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('myPhoneId', myPhoneId);
        }

        // --- PRIKAZIVANJE TERENA ---
        const tereniRef = ref(db, 'tereni');
        onValue(tereniRef, (snapshot) => {
            // Ukloni trenutne markere pre osvežavanja
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });

            const data = snapshot.val();
            if (data) {
                Object.keys(data).forEach(id => {
                    const t = data[id];
                    const marker = L.marker([t.lat, t.lng]).addTo(map);
                    // Ako je to teren ovog telefona, oboji ga drugačije ili naglasi
                    if (id === myPhoneId) {
                        marker.bindPopup(`<b>Vaš teren: ${t.ime}</b>`).openPopup();
                    } else {
                        marker.bindPopup(`<b>Teren: ${t.ime}</b>`);
                    }
                });
            }
        });

        // --- DODAVANJE / POMERANJE TERENA ---
        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            
            const ime = prompt("Unesite ime terena (stara lokacija će biti obrisana):");
            
            if (ime && ime.trim() !== "") {
                // 'set' na istu putanju (myPhoneId) automatski briše prethodne podatke tog telefona
                set(ref(db, 'tereni/' + myPhoneId), {
                    ime: ime,
                    lat: lat,
                    lng: lng,
                    vreme: new Date().toISOString()
                }).then(() => {
                    console.log("Lokacija ažurirana.");
                }).catch((error) => {
                    alert("Greška: " + error.message);
                });
            }
        });
    </script>
</body>
</html>
