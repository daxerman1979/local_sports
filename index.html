<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Who Play? Stable</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body,#map{height:100%;margin:0;}
#panel{
 position:fixed;bottom:0;left:0;width:100%;
 background:#111;color:white;padding:12px;
 border-radius:16px 16px 0 0;
 display:none;
}
button{padding:8px 12px;margin:4px;border-radius:8px;border:none;font-weight:bold;}
input{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc;}
.live{color:red;font-weight:bold;}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <b id="courtTitle"></b><br><br>
  <input id="teamA" placeholder="Tim A">
  <input id="teamB" placeholder="Tim B">
  <button onclick="goLive()">GO LIVE</button>
  <div id="livePanel" style="display:none;">
    <div class="live">LIVE</div>
    <div>
      <span id="labelA"></span>
      <button onclick="addA()">+1</button>
      <span id="scoreA">0</span>
    </div>
    <div>
      <span id="labelB"></span>
      <button onclick="addB()">+1</button>
      <span id="scoreB">0</span>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* FIREBASE */
firebase.initializeApp({
  databaseURL: "https://allsportslocal-ea1d4-default-rtdb.europe-west1.firebasedatabase.app"
});
const db = firebase.database();

/* MAP */
const map = L.map('map').setView([44.8178,20.4489],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let currentId = null;
let markers = {};

/* LOAD COURTS */
db.ref('tereni').on('value', snap=>{
  Object.values(markers).forEach(m=>map.removeLayer(m));
  markers={};
  const data = snap.val();
  if(!data) return;
  for(const id in data){
    const c=data[id];
    const m=L.marker([c.lat,c.lng]).addTo(map);
    m.on('click',()=>openPanel(id,c));
    markers[id]=m;
  }
});

/* CLICK MAP = ADD COURT */
map.on('click',e=>{
  const name=prompt("Ime terena?");
  if(!name) return;
  db.ref('tereni').push({
    ime:name,lat:e.latlng.lat,lng:e.latlng.lng,
    status:'idle',scoreA:0,scoreB:0,teamA:'',teamB:''
  });
});

function openPanel(id,c){
  currentId=id;
  document.getElementById('panel').style.display='block';
  document.getElementById('courtTitle').innerText=c.ime;
  document.getElementById('teamA').value=c.teamA||'';
  document.getElementById('teamB').value=c.teamB||'';
  document.getElementById('livePanel').style.display='none';
}

function goLive(){
  const a=teamA.value;
  const b=teamB.value;
  db.ref('tereni/'+currentId).update({
    status:'live',teamA:a,teamB:b,scoreA:0,scoreB:0
  });
  labelA.innerText=a;
  labelB.innerText=b;
  livePanel.style.display='block';
}

function addA(){
  db.ref('tereni/'+currentId+'/scoreA').transaction(v=>(v||0)+1);
}
function addB(){
  db.ref('tereni/'+currentId+'/scoreB').transaction(v=>(v||0)+1);
}
</script>

</body>
</html>
