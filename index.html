<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HoodLive - Ultimate Tracker</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Inter:wght@400;700;900&family=Permanent+Marker&display=swap" rel="stylesheet">
    
    <style>
        /* OSNOVNI STIL (HoodLive) */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-size: 16px; }
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background: #000; position: fixed; font-family: 'Inter', sans-serif; }
        
        #hero { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1574629810360-7efbbe195018?q=80&w=1500&auto=format&fit=crop') center/cover; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 6000; color: white; padding: 20px; }
        .hero-logo { font-family: 'Permanent Marker', cursive; font-size: 56px; color: #ff3b30; text-shadow: 3px 3px 0px #000; margin-bottom: 5px; transform: rotate(-3deg); }
        .auth-box { background: rgba(0,0,0,0.7); backdrop-filter: blur(20px); padding: 30px; border-radius: 25px; width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 12px; border: 1px solid rgba(255,59,48,0.3); }
        .auth-btn { background: #ff3b30; color: white; border: none; padding: 16px; font-weight: 900; border-radius: 12px; font-family: 'Oswald'; font-size: 18px; cursor: pointer; }
        
        #map { width: 100vw; height: 100vh; background: #000; display: none; }
        
        /* ADMIN PANEL - INTEGRACIJA TVOG SISTEMA */
        #admin-panel { position: fixed; top: 0; left: 100%; width: 100%; height: 100%; background: #0d0d0d; z-index: 7000; transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); padding: 15px; overflow-y: auto; color: #f0f0f0; }
        #admin-panel.active { left: 0; }
        
        .scoreboard-container { background: #1a1a1a; border-radius: 15px; padding: 15px; border: 1px solid #333; margin-top: 10px; }
        .main-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .total-points { font-size: 3rem; font-weight: 800; font-family: 'Oswald'; color: #ff3b30; }
        .sub-label { color: #00e676; font-weight: bold; font-size: 1.2rem; min-height: 1.5rem; text-align: center; }

        .score-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        .score-table th { color: #666; padding: 5px; text-transform: uppercase; }
        .score-table td { border: 1px solid #2a2a2a; padding: 8px; text-align: center; font-weight: bold; }
        .active-p { background: rgba(0, 230, 118, 0.15); color: #00e676; border: 1px solid #00e676 !important; }

        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-plus { background: #1b5e20; color: white; padding: 15px; font-weight: bold; border-radius: 8px; font-size: 1.1rem; }
        .btn-minus { background: #b71c1c; color: white; padding: 8px; font-weight: bold; border-radius: 8px; }
        .btn-action { grid-column: span 2; background: #222; color: white; padding: 12px; border-radius: 8px; font-weight: bold; border: 1px solid #444; }
        
        .disabled { opacity: 0.2; pointer-events: none; }

        /* MARKERI NA MAPI */
        .sport-marker-wrapper { display: flex; align-items: center; white-space: nowrap; }
        .live-card-thin { background: #000; border: 1px solid #333; border-radius: 12px; padding: 4px 12px; display: flex; align-items: center; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .match-score-thin { font-size: 1.2rem; color: #ff3b30; font-weight: bold; margin-left: 10px; font-family: 'Oswald'; }
        
        /* POPUP STIL */
        .leaflet-popup-content-wrapper { background: #111; color: white; border-radius: 15px; }
        .pop-btn { background: #ff3b30; color: white; width: 100%; padding: 10px; border-radius: 8px; font-family: 'Oswald'; border: none; margin-top: 10px; }
        input, select { background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 5px; width: 100%; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="hero">
        <div class="hero-logo">HoodLive</div>
        <div class="auth-box">
            <input type="email" id="email" placeholder="EMAIL">
            <input type="password" id="password" placeholder="PASSWORD">
            <button class="auth-btn" onclick="handleAuth()">ULAZ U SISTEM</button>
            <button style="background:none; border:1px solid #fff; color:#fff; padding:10px; border-radius:12px; margin-top:5px;" onclick="exploreMap()">SAMO PREGLED</button>
        </div>
    </div>

    <div id="map"></div>

    <div id="admin-panel">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h2 id="adm-court-name" style="font-family:'Oswald'; margin:0;">NAZIV TERENA</h2>
            <div onclick="closeAdmin()" style="font-size:30px; color:#ff3b30; cursor:pointer;">&times;</div>
        </div>

        <div id="setup-view" style="display:none; margin-top:20px;">
            <input type="text" id="team-h-input" placeholder="DOMAĆI TIM">
            <input type="text" id="team-a-input" placeholder="GOSTUJUĆI TIM">
            <button class="pop-btn" onclick="initMatch()">ZAKAŽI / KREIRAJ MEČ</button>
        </div>

        <div id="score-view" style="display:none;">
            <div class="scoreboard-container">
                <div class="main-display">
                    <div style="flex:1; text-align:center;">
                        <div id="disp-name-h" style="font-weight:900; font-size:0.9rem;">DOMAĆIN</div>
                        <div id="sub-h" class="sub-label"></div>
                    </div>
                    <div class="total-points"><span id="main-h">0</span>:<span id="main-a">0</span></div>
                    <div style="flex:1; text-align:center;">
                        <div id="disp-name-a" style="font-weight:900; font-size:0.9rem;">GOST</div>
                        <div id="sub-a" class="sub-label"></div>
                    </div>
                </div>
                <table class="score-table" id="score-table-ui"></table>
            </div>

            <div class="admin-grid">
                <button id="live-start-btn" class="btn-action" style="background:#ff3b30;" onclick="updateStatus('live')">KRENI LIVE (UŽIVO)</button>
                
                <div id="live-controls" class="admin-grid" style="grid-column: span 2;">
                    <button class="btn-plus" onclick="adjustScore(1, 'h')">DOM +1</button>
                    <button class="btn-plus" onclick="adjustScore(1, 'a')">GOS +1</button>
                    <button class="btn-minus" onclick="adjustScore(-1, 'h')">-1</button>
                    <button class="btn-minus" onclick="adjustScore(-1, 'a')">-1</button>
                    <button id="next-p-btn" class="btn-action" onclick="goNext()">SLEDEĆI PERIOD</button>
                </div>

                <button class="btn-action" style="color:#ff3b30;" onclick="updateStatus('ended')">KRAJ MEČA</button>
                <button class="btn-action" onclick="resetMatch()">RESET / NOVI MEČ</button>
            </div>
        </div>
        
        <button id="del-btn" style="margin-top:30px; background:none; border:none; color:#444; width:100%;" onclick="deleteCourt()">OBRIŠI TEREN</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // FIREBASE KONFIGURACIJA (Tvoja originalna)
        const firebaseConfig = { 
            apiKey: "AIzaSyCyyqnqeS-9jurBX-6VIRp8CiPTMbXkXgw",
            authDomain: "allsportslocal-ea1d4.firebaseapp.com",
            databaseURL: "https://allsportslocal-ea1d4-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "allsportslocal-ea1d4"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // LOGIKA BODOVANJA (Tvoj sistem)
        const sportsConfig = {
            FUDBAL: { p: ['1H', '2H'], mode: 'sum' },
            KOŠARKA: { p: ['Q1', 'Q2', 'Q3', 'Q4'], mode: 'sum' },
            RUKOMET: { p: ['1H', '2H'], mode: 'sum' },
            ODBOJKA: { p: ['S1', 'S2', 'S3', 'S4', 'S5'], mode: 'sets', target: 25, decider: 15 },
            TENIS: { p: ['S1', 'S2', 'S3'], mode: 'sets' }
        };

        let map, allTereni = [], currentKey = null, userMarker;
        const tennisPoints = ["0", "15", "30", "40", "AD"];

        // INIT
        function handleAuth() {
            const e = document.getElementById('email').value, p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e, p).catch(() => auth.createUserWithEmailAndPassword(e, p));
        }

        auth.onAuthStateChanged(user => { if(user) exploreMap(); });

        function exploreMap() {
            document.getElementById('hero').style.display='none';
            document.getElementById('map').style.display='block';
            initMap();
        }

        function initMap() {
            if(map) return;
            map = L.map('map', { zoomControl: false }).setView([44.7866, 20.4489], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            db.ref('tereni').on('value', snap => {
                allTereni = [];
                snap.forEach(s => { let d = s.val(); d.key = s.key; allTereni.push(d); });
                renderMarkers();
                if(currentKey) syncAdminUI();
            });

            map.on('click', e => {
                if(!auth.currentUser) return;
                const html = `<div><b>KREIRAJ TEREN</b><br><select id="p_sport"><option>FUDBAL</option><option>KOŠARKA</option><option>TENIS</option><option>ODBOJKA</option></select><br><input id="p_name" placeholder="Ime terena"><button class="pop-btn" onclick="saveCourt(${e.latlng.lat},${e.latlng.lng})">SAČUVAJ</button></div>`;
                L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
            });
        }

        async function saveCourt(lat, lng) {
            const name = document.getElementById('p_name').value, sport = document.getElementById('p_sport').value;
            await db.ref('tereni').push({ name, sport, lat, lng, owner: auth.currentUser.uid, status: 'upcoming' });
            map.closePopup();
        }

        function renderMarkers() {
            map.eachLayer(l => { if(l instanceof L.Marker && l !== userMarker) map.removeLayer(l); });
            allTereni.forEach(d => {
                const isLive = d.status === 'live';
                const scoreStr = d.t1 ? `${d.score1}:${d.score2}` : "SLOBODAN";
                const icon = L.divIcon({
                    className: '',
                    html: `<div class="sport-marker-wrapper">
                            <div class="live-card-thin" style="border-color:${isLive?'#ff3b30':'#333'}">
                                <div style="font-size:10px;">${d.name}<br><b>${d.t1 || d.sport}</b></div>
                                <div class="match-score-thin">${scoreStr}</div>
                            </div>
                           </div>`,
                    iconSize: [120, 40]
                });
                L.marker([d.lat, d.lng], { icon }).addTo(map).on('click', () => {
                    if(auth.currentUser && d.owner === auth.currentUser.uid) openAdmin(d.key);
                });
            });
        }

        // ADMIN LOGIKA (Integrisan tvoj sistem)
        function openAdmin(key) {
            currentKey = key;
            document.getElementById('admin-panel').classList.add('active');
            syncAdminUI();
        }

        function syncAdminUI() {
            const d = allTereni.find(x => x.key === currentKey);
            if(!d) return;
            
            document.getElementById('adm-court-name').innerText = d.name;
            
            if(!d.t1) {
                document.getElementById('setup-view').style.display = 'block';
                document.getElementById('score-view').style.display = 'none';
            } else {
                document.getElementById('setup-view').style.display = 'none';
                document.getElementById('score-view').style.display = 'block';
                
                // Popunjavanje tvojih polja
                document.getElementById('disp-name-h').innerText = d.t1;
                document.getElementById('disp-name-a').innerText = d.t2;
                document.getElementById('main-h').innerText = d.score1 || 0;
                document.getElementById('main-a').innerText = d.score2 || 0;
                
                // Pod-rezultat (Tenis poeni)
                if(d.sport === 'TENIS') {
                    document.getElementById('sub-h').innerText = d.tb ? d.tIdx1 : tennisPoints[d.tIdx1 || 0];
                    document.getElementById('sub-a').innerText = d.tb ? d.tIdx2 : tennisPoints[d.tIdx2 || 0];
                } else {
                    document.getElementById('sub-h').innerText = ""; document.getElementById('sub-a').innerText = "";
                }

                renderTable(d);
                
                // Kontrola dugmića
                document.getElementById('live-controls').className = d.status === 'live' ? 'admin-grid' : 'admin-grid disabled';
                document.getElementById('live-start-btn').style.display = d.status === 'upcoming' ? 'block' : 'none';
                document.getElementById('next-p-btn').style.display = (d.sport === 'TENIS' || d.sport === 'ODBOJKA') ? 'none' : 'block';
            }
        }

        function renderTable(d) {
            const conf = sportsConfig[d.sport];
            const pList = conf.p;
            const curP = d.currentP || 0;
            const sDetails = d.sub_details || {};

            let html = `<tr><th>TIM</th>${pList.map(p => `<th>${p}</th>`).join('')}</tr>`;
            html += `<tr><td>DOM</td>${pList.map((p, i) => `<td class="${i===curP?'active-p':''}">${sDetails[p]?.h || 0}</td>`).join('')}</tr>`;
            html += `<tr><td>GOS</td>${pList.map((p, i) => `<td class="${i===curP?'active-p':''}">${sDetails[p]?.a || 0}</td>`).join('')}</tr>`;
            document.getElementById('score-table-ui').innerHTML = html;
        }

        async function initMatch() {
            const t1 = document.getElementById('team-h-input').value.toUpperCase();
            const t2 = document.getElementById('team-a-input').value.toUpperCase();
            if(!t1 || !t2) return;
            await db.ref(`tereni/${currentKey}`).update({ t1, t2, score1:0, score2:0, currentP:0, status:'upcoming', sub_details:{} });
        }

        // GLAVNA ADJUST FUNKCIJA (Tvoja logika + Firebase)
        async function adjustScore(val, team) {
            const d = allTereni.find(x => x.key === currentKey);
            const conf = sportsConfig[d.sport];
            const pName = conf.p[d.currentP || 0];
            const other = team === 'h' ? 'a' : 'h';
            
            let upd = {};
            let sub = d.sub_details || {};
            if(!sub[pName]) sub[pName] = { h:0, a:0 };

            if(d.sport === 'TENIS') {
                await handleTennisLogic(d, val, team, pName);
            } else if(d.sport === 'ODBOJKA') {
                sub[pName][team] = Math.max(0, sub[pName][team] + val);
                let target = (d.currentP === 4) ? conf.decider : conf.target;
                if(sub[pName][team] >= target && (sub[pName][team] - sub[pName][other]) >= 2) {
                    // Automatski set
                    let s1 = d.score1, s2 = d.score2;
                    if(team === 'h') s1++; else s2++;
                    await db.ref(`tereni/${currentKey}`).update({ score1:s1, score2:s2, currentP: (d.currentP||0)+1, sub_details: sub });
                } else {
                    await db.ref(`tereni/${currentKey}/sub_details/${pName}`).update(sub[pName]);
                }
            } else {
                // Fudbal, Košarka...
                sub[pName][team] = Math.max(0, sub[pName][team] + val);
                let s1 = 0, s2 = 0;
                Object.values(sub).forEach(v => { s1 += v.h; s2 += v.a; });
                await db.ref(`tereni/${currentKey}`).update({ score1: s1, score2: s2, sub_details: sub });
            }
        }

        async function handleTennisLogic(d, val, team, pName) {
            let t1 = d.tIdx1 || 0, t2 = d.tIdx2 || 0;
            let g1 = d.sub_details?.[pName]?.h || 0, g2 = d.sub_details?.[pName]?.a || 0;
            let s1 = d.score1, s2 = d.score2;

            if(d.tb) { // Tie-break
                if(team === 'h') t1 += val; else t2 += val;
                if(t1 >= 7 && (t1 - t2) >= 2) { g1++; s1++; t1=0; t2=0; await db.ref(`tereni/${currentKey}`).update({score1:s1, tIdx1:0, tIdx2:0, tb:false, currentP:d.currentP+1}); }
                else if(t2 >= 7 && (t2 - t1) >= 2) { g2++; s2++; t1=0; t2=0; await db.ref(`tereni/${currentKey}`).update({score2:s2, tIdx1:0, tIdx2:0, tb:false, currentP:d.currentP+1}); }
                else { await db.ref(`tereni/${currentKey}`).update({ tIdx1:t1, tIdx2:t2 }); }
            } else { // Standard
                if(val === 1) {
                    if(team === 'h') {
                        if(t1 === 3 && t2 < 3) { g1++; t1=0; t2=0; }
                        else if(t1 === 3 && t2 === 3) t1 = 4;
                        else if(t1 === 3 && t2 === 4) t2 = 3;
                        else if(t1 === 4) { g1++; t1=0; t2=0; }
                        else t1++;
                    } else {
                        if(t2 === 3 && t1 < 3) { g2++; t1=0; t2=0; }
                        else if(t2 === 3 && t1 === 3) t2 = 4;
                        else if(t2 === 3 && t1 === 4) t1 = 3;
                        else if(t2 === 4) { g2++; t1=0; t2=0; }
                        else t2++;
                    }
                }
                // Provera kraja seta
                if(g1 === 6 && g2 === 6) { 
                    await db.ref(`tereni/${currentKey}`).update({ tb:true, tIdx1:0, tIdx2:0, [`sub_details/${pName}/h`]:6, [`sub_details/${pName}/a`]:6 });
                } else if((g1 >= 6 && g1-g2 >= 2) || g1 === 7) {
                    s1++; await db.ref(`tereni/${currentKey}`).update({ score1:s1, tIdx1:0, tIdx2:0, currentP:d.currentP+1, [`sub_details/${pName}/h`]:g1 });
                } else if((g2 >= 6 && g2-g1 >= 2) || g2 === 7) {
                    s2++; await db.ref(`tereni/${currentKey}`).update({ score2:s2, tIdx1:0, tIdx2:0, currentP:d.currentP+1, [`sub_details/${pName}/a`]:g2 });
                } else {
                    await db.ref(`tereni/${currentKey}`).update({ tIdx1:t1, tIdx2:t2, [`sub_details/${pName}/h`]:g1, [`sub_details/${pName}/a`]:g2 });
                }
            }
        }

        function goNext() {
            const d = allTereni.find(x => x.key === currentKey);
            db.ref(`tereni/${currentKey}`).update({ currentP: (d.currentP || 0) + 1 });
        }

        function updateStatus(s) { db.ref(`tereni/${currentKey}`).update({ status: s }); }
        
        function resetMatch() {
            if(confirm("Novi meč?")) db.ref(`tereni/${currentKey}`).update({ t1:null, t2:null, score1:0, score2:0, status:'upcoming', sub_details:{}, currentP:0, tIdx1:0, tIdx2:0, tb:false });
        }

        function closeAdmin() { document.getElementById('admin-panel').classList.remove('active'); currentKey = null; }
        
        function deleteCourt() { if(confirm("Obriši teren?")) { db.ref(`tereni/${currentKey}`).remove(); closeAdmin(); } }
    </script>
</body>
</html>
