<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOCALIVE - Smart Sports Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { --primary: #e74c3c; --dark: #121212; --accent: #2ecc71; --blue: #3498db; --grey: #7f8c8d; }

        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; position: fixed; background: #000;
            font-family: -apple-system, system-ui, sans-serif;
        }

        #map { width: 100%; height: 100%; position: absolute; z-index: 1; transition: filter 0.8s ease; }
        .map-blur { filter: blur(15px) brightness(0.3); pointer-events: none; }

        /* STARTUP SCREEN */
        #startup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10001; display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.8);
        }
        .startup-card {
            background: white; padding: 35px 25px; border-radius: 30px;
            width: 85%; max-width: 330px; text-align: center;
            box-shadow: 0 15px 45px rgba(0,0,0,0.8);
        }
        .startup-card h1 { font-size: 35px; font-weight: 900; color: var(--primary); margin: 0; letter-spacing: -1px; }

        /* UI ELEMENTS */
        header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
            display: flex; justify-content: space-between; align-items: center;
            padding: env(safe-area-inset-top) 15px 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            pointer-events: none;
        }
        .logo, .nav-links { pointer-events: auto; }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .nav-btn { background: rgba(0,0,0,0.6); border: 1px solid #fff; color: white; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; }

        /* SCOREBOARD ON MAP */
        .map-scoreboard {
            background: #000; border: 2px solid #fff; border-radius: 12px;
            width: 220px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .score-name-row { background: #fff; color: #000; font-size: 11px; font-weight: 900; padding: 5px; text-align: center; text-transform: uppercase; }
        .score-main-row { display: flex; align-items: stretch; min-height: 45px; }
        .status-tag { width: 30px; font-size: 9px; font-weight: 900; color: #fff; writing-mode: vertical-lr; text-align: center; display: flex; align-items: center; justify-content: center; transform: rotate(180deg); }
        .match-info { flex: 1; padding: 8px; color: #fff; font-weight: 900; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .emoji-box { font-size: 24px; padding: 5px; background: #1a1a1a; display: flex; justify-content: center; }

        /* STATUS COLORS */
        .bg-live { background: var(--primary); animation: blink 1s infinite; }
        .bg-ft { background: #555; }
        .bg-free { background: var(--accent); }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* PANELS */
        #admin-panel, #match-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; z-index: 3000;
            background: var(--dark); color: white; padding: 20px;
            border-radius: 25px 25px 0 0; transform: translateY(100%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-sizing: border-box;
        }
        .active { transform: translateY(0) !important; }

        .sport-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .sport-item { background: #222; border: 2px solid #333; border-radius: 12px; padding: 10px; text-align: center; cursor: pointer; }
        .sport-item.selected { border-color: var(--primary); background: rgba(231, 76, 60, 0.1); }
        
        .score-display { font-size: 45px; font-weight: 900; color: var(--accent); line-height: 1; margin: 10px 0; }
        .score-btn { background: #333; color: #fff; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 900; margin: 4px; font-size: 16px; }

        .btn-action { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; margin-bottom: 10px; }
        
        input { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 12px; border: 2px solid #333; background: #000; color: #fff; box-sizing: border-box; font-size: 16px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10002; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="startup-screen">
        <div class="startup-card">
            <h1>LOCALIVE</h1>
            <p style="font-weight: 800; color: #555;">Sportska mapa tvog grada</p>
            <button class="btn-action" style="background: var(--primary); color: #fff;" onclick="toggleModal('login-screen', true)">ADMIN LOGIN</button>
            <button class="btn-action" style="background: #eee; color: #000;" onclick="startExplore()">ISTRA≈ΩI MAPU üåç</button>
        </div>
    </div>

    <div id="login-screen" class="overlay hidden">
        <div class="startup-card">
            <h2 style="margin-top:0">Admin Prijava</h2>
            <input type="email" id="login-email" placeholder="Email adresa">
            <button class="btn-action" style="background: var(--accent); color:#fff" onclick="loginAdmin()">PRIJAVI SE</button>
            <button class="btn-action" style="background: none; color: #999;" onclick="toggleModal('login-screen', false)">ZATVORI</button>
        </div>
    </div>

    <header id="main-header" class="hidden">
        <div class="logo">LOCALIVE</div>
        <div id="admin-controls" class="nav-links hidden">
            <span id="admin-name" style="color:white; font-size:12px; font-weight:900; margin-right:10px"></span>
            <button class="nav-btn" onclick="logoutAdmin()">LOGOUT</button>
        </div>
    </header>

    <div id="admin-panel">
        <h3 style="margin-top:0; color: var(--primary)">DODAJ TEREN</h3>
        <input type="text" id="court-name" placeholder="Naziv lokacije (npr. Ada Ciganlija)">
        <div class="sport-grid" id="sport-selector">
            <div class="sport-item selected" onclick="selectSport('‚öΩ', 'fudbal', this)">‚öΩ<br><small>Fudbal</small></div>
            <div class="sport-item" onclick="selectSport('üèÄ', 'kosarka', this)">üèÄ<br><small>Basket</small></div>
            <div class="sport-item" onclick="selectSport('üéæ', 'tenis', this)">üéæ<br><small>Tenis</small></div>
        </div>
        <button class="btn-action" style="background: var(--accent); color:#fff" onclick="saveCourt()">POSTAVI MARKER</button>
        <button class="btn-action" style="background: #333; color:#fff" onclick="zatvoriSvePanele()">OTKA≈ΩI</button>
    </div>

    <div id="match-panel">
        <div id="match-setup">
            <h3 id="target-court-name" style="margin-top:0">UREDI MEƒå</h3>
            <input type="text" id="team-a" placeholder="Domaƒáin">
            <input type="text" id="team-b" placeholder="Gost">
            <button class="btn-action" style="background: var(--primary); color:#fff" onclick="updateStatus('live')">POƒåNI MEƒå üî¥</button>
            <button class="btn-action" style="background: #c0392b; color:#fff" onclick="obrisiTeren()">OBRI≈†I LOKACIJU</button>
        </div>

        <div id="match-live" class="hidden">
            <div style="display:flex; justify-content: space-around; align-items: center;">
                <div style="text-align:center">
                    <div id="score-a" class="score-display">0</div>
                    <div id="btns-a"></div>
                </div>
                <div style="font-weight:900; font-size:24px">VS</div>
                <div style="text-align:center">
                    <div id="score-b" class="score-display">0</div>
                    <div id="btns-b"></div>
                </div>
            </div>
            <div id="period-controls" style="margin-top:15px"></div>
            <button class="btn-action" style="background: #555; color:#fff; margin-top:15px" onclick="updateStatus('zavrseno')">ZAVR≈†I MEƒå (FT)</button>
        </div>
    </div>

    <div id="map" class="map-blur"></div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // FIREBASE SETUP
        const firebaseConfig = { databaseURL: "https://allsportslocal-ea1d4-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // MAP SETUP
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([44.81, 20.46], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let isAdmin = false;
        let tempCoords = null;
        let tempMarker = null;
        let currentCourtId = null;
        let selectedSport = { emoji: '‚öΩ', slug: 'fudbal' };
        const courtMarkers = L.layerGroup().addTo(map);

        // INITIALIZE
        function startExplore() {
            document.getElementById('startup-screen').classList.add('hidden');
            document.getElementById('map').classList.remove('map-blur');
            document.getElementById('main-header').classList.remove('hidden');
            map.invalidateSize();
            loadCourts();
            
            const logged = localStorage.getItem('loggedAdmin');
            if(logged) setupAdminUI(JSON.parse(logged));
        }

        // ADMIN LOGIC
        function loginAdmin() {
            const email = document.getElementById('login-email').value.toLowerCase().trim();
            db.ref('admins').orderByChild('email').equalTo(email).once('value', snap => {
                if(snap.exists()) {
                    const data = Object.values(snap.val())[0];
                    localStorage.setItem('loggedAdmin', JSON.stringify(data));
                    setupAdminUI(data);
                    toggleModal('login-screen', false);
                    startExplore();
                } else {
                    alert("Email nije pronaƒëen u bazi admina.");
                }
            });
        }

        function setupAdminUI(admin) {
            isAdmin = true;
            document.getElementById('admin-controls').classList.remove('hidden');
            document.getElementById('admin-name').innerText = admin.nickname;
        }

        function logoutAdmin() {
            localStorage.removeItem('loggedAdmin');
            location.reload();
        }

        // MAP CLICK (DODAVANJE)
        map.on('click', e => {
            if(!isAdmin) return;
            tempCoords = e.latlng;
            if(tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker(e.latlng).addTo(map);
            document.getElementById('admin-panel').classList.add('active');
        });

        function saveCourt() {
            const name = document.getElementById('court-name').value;
            if(!name) return alert("Unesi ime terena");
            
            db.ref('tereni').push({
                ime: name,
                sport: selectedSport.slug,
                emoji: selectedSport.emoji,
                lat: tempCoords.lat,
                lng: tempCoords.lng,
                status: 'slobodno',
                scoreA: 0, scoreB: 0,
                timA: '', timB: '',
                arhiva: ''
            }).then(() => {
                zatvoriSvePanele();
                document.getElementById('court-name').value = '';
            });
        }

        // LOADING & RENDERING
        function loadCourts() {
            db.ref('tereni').on('value', snap => {
                courtMarkers.clearLayers();
                const data = snap.val();
                for(let id in data) {
                    renderMarker(id, data[id]);
                }
            });
        }

        function renderMarker(id, c) {
            const statusClass = c.status === 'live' ? 'bg-live' : (c.status === 'zavrseno' ? 'bg-ft' : 'bg-free');
            const html = `
                <div class="map-scoreboard">
                    <div class="score-name-row">${c.ime}</div>
                    <div class="score-main-row">
                        <div class="status-tag ${statusClass}">${c.status.toUpperCase()}</div>
                        <div class="match-info">
                            <div style="font-size:14px">${c.timA || 'SLOBODAN'}</div>
                            <div style="font-size:18px; color:var(--accent)">${c.scoreA} : ${c.scoreB}</div>
                            <div style="font-size:14px">${c.timB || 'TEREN'}</div>
                        </div>
                    </div>
                    ${c.arhiva ? `<div style="font-size:9px; background:#111; color:#999; text-align:center; padding:2px">${c.arhiva}</div>` : ''}
                    <div class="emoji-box">${c.emoji}</div>
                </div>
            `;

            const m = L.marker([c.lat, c.lng], {
                icon: L.divIcon({ html: html, iconSize: [220, 90], iconAnchor: [110, 45], className: '' })
            }).addTo(courtMarkers);

            m.on('click', () => {
                if(isAdmin) otvoriUredi(id);
            });
        }

        function otvoriUredi(id) {
            currentCourtId = id;
            db.ref('tereni/' + id).once('value', snap => {
                const c = snap.val();
                document.getElementById('target-court-name').innerText = c.ime;
                document.getElementById('team-a').value = c.timA;
                document.getElementById('team-b').value = c.timB;
                
                setupLiveControls(c);
                document.getElementById('match-panel').classList.add('active');
                
                const isLive = c.status === 'live' || c.status === 'zavrseno';
                document.getElementById('match-setup').classList.toggle('hidden', isLive);
                document.getElementById('match-live').classList.toggle('hidden', !isLive);
            });
        }

        function setupLiveControls(c) {
            const bA = document.getElementById('btns-a');
            const bB = document.getElementById('btns-b');
            const pC = document.getElementById('period-controls');
            
            bA.innerHTML = bB.innerHTML = pC.innerHTML = '';
            
            // Score buttons
            const pts = c.sport === 'kosarka' ? [1, 2, 3] : [1];
            pts.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'score-btn';
                btn.innerText = '+' + p;
                btn.onclick = () => db.ref(`tereni/${currentCourtId}/scoreA`).transaction(v => (v||0)+p);
                bA.appendChild(btn);

                const btnB = document.createElement('button');
                btnB.className = 'score-btn';
                btnB.innerText = '+' + p;
                btnB.onclick = () => db.ref(`tereni/${currentCourtId}/scoreB`).transaction(v => (v||0)+p);
                bB.appendChild(btnB);
            });

            // Period button
            const pBtn = document.createElement('button');
            pBtn.className = 'btn-action';
            pBtn.style.background = 'var(--blue)';
            pBtn.innerText = "ARHIVIRAJ PERIOD";
            pBtn.onclick = () => {
                const res = `${c.scoreA}:${c.scoreB}`;
                const novaArhiva = c.arhiva ? c.arhiva + ", " + res : res;
                db.ref(`tereni/${currentCourtId}`).update({ arhiva: novaArhiva });
            };
            pC.appendChild(pBtn);

            // Sync score display
            db.ref(`tereni/${currentCourtId}`).on('value', s => {
                const val = s.val();
                if(val) {
                    document.getElementById('score-a').innerText = val.scoreA;
                    document.getElementById('score-b').innerText = val.scoreB;
                }
            });
        }

        function updateStatus(s) {
            const update = {
                status: s,
                timA: document.getElementById('team-a').value || 'Tim A',
                timB: document.getElementById('team-b').value || 'Tim B'
            };
            db.ref('tereni/'+currentCourtId).update(update);
            if(s === 'live') {
                document.getElementById('match-setup').classList.add('hidden');
                document.getElementById('match-live').classList.remove('hidden');
            } else {
                zatvoriSvePanele();
            }
        }

        // HELPERS
        function selectSport(emoji, slug, el) {
            selectedSport = { emoji, slug };
            document.querySelectorAll('.sport-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
        }

        function toggleModal(id, show) {
            document.getElementById(id).classList.toggle('hidden', !show);
        }

        function zatvoriSvePanele() {
            document.getElementById('admin-panel').classList.remove('active');
            document.getElementById('match-panel').classList.remove('active');
            if(tempMarker) map.removeLayer(tempMarker);
            db.ref('tereni').off(); // Clean listeners
            loadCourts(); // Re-establish main listener
        }

        function obrisiTeren() {
            if(confirm("Obri≈°i ovaj teren trajno?")) {
                db.ref('tereni/'+currentCourtId).remove();
                zatvoriSvePanele();
            }
        }
    </script>
</body>
</html>
