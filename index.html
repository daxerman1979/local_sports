<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HoodSport | Live Map</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background: #0f172a; touch-action: manipulation; }
        #map { height: 100vh; width: 100vw; display: none; }
        input { font-size: 16px !important; }

        /* SUPER SEARCH */
        .leaflet-control-geocoder {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15) !important;
            border-radius: 50px !important;
        }
        .leaflet-control-geocoder-form input { background: transparent !important; color: white !important; }
        .leaflet-control-geocoder-alternatives { background: white !important; color: black !important; border-radius: 12px; margin-top: 10px; }

        /* JEZIƒåAK NA DINU */
        #bottom-trigger {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100px; height: 18px; background: rgba(59, 130, 246, 0.4);
            backdrop-filter: blur(8px); border-radius: 12px 12px 0 0; z-index: 2001;
            border: 1px solid rgba(255,255,255,0.2); border-bottom: none;
        }
        #bottom-trigger::after { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 35px; height: 4px; background: white; border-radius: 2px; }

        /* BOTTOM SHEET */
        #sidebar { 
            position: fixed; bottom: 0; left: 0; right: 0; height: 70vh;
            background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(25px);
            z-index: 2005; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-top: 1px solid rgba(255,255,255,0.1); border-radius: 30px 30px 0 0;
        }
        .sidebar-closed { transform: translateY(100%); }

        /* CUSTOM MARKER - LOPTICA I IME */
        .court-marker { display: flex; align-items: center; white-space: nowrap; }
        .court-icon { 
            font-size: 20px; background: white; border-radius: 50%; 
            width: 30px; height: 30px; display: flex; align-items: center; 
            justify-content: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 2;
        }
        .court-label {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px);
            color: white; padding: 4px 12px 4px 20px; border-radius: 0 20px 20px 0;
            margin-left: -15px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1);
            font-size: 12px; z-index: 1;
        }

        /* GPS DUGME */
        #gps-button {
            position: fixed; bottom: 35px; right: 20px; width: 55px; height: 55px;
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 18px; z-index: 2000;
        }

        .pulse-marker { width: 14px; height: 14px; background: #3b82f6; border-radius: 50%; border: 2px solid white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    </style>
</head>
<body class="text-white">

    <div id="auth-screen" class="h-screen flex flex-col justify-center items-center px-6">
        <h1 class="text-5xl font-black text-blue-500 mb-8 italic tracking-tighter">HOODSPORT</h1>
        <div class="w-full max-w-sm space-y-4">
            <input id="email" type="email" placeholder="Email" class="w-full p-4 bg-slate-800 rounded-2xl outline-none">
            <input id="password" type="password" placeholder="Lozinka" class="w-full p-4 bg-slate-800 rounded-2xl outline-none">
            <button onclick="handleAuth()" class="w-full py-4 bg-blue-600 rounded-2xl font-bold">Uƒëi na mapu</button>
        </div>
    </div>

    <div id="map"></div>
    <button id="gps-button" class="hidden flex items-center justify-center" onclick="findMe()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-400" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
    </button>
    <button id="bottom-trigger" class="hidden" onclick="toggleSidebar()"></button>

    <div id="sidebar" class="sidebar-closed p-6 flex flex-col">
        <div class="w-16 h-1.5 bg-white/20 rounded-full mx-auto mb-6 cursor-pointer" onclick="toggleSidebar()"></div>
        
        <div id="menu-main" class="flex-grow space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-3xl text-blue-500 italic">HoodSport</h2>
                <button onclick="toggleSidebar()" class="text-2xl">&times;</button>
            </div>
            <button onclick="showSportSelect()" class="w-full py-5 bg-blue-600 rounded-2xl font-bold text-xl">‚ûï DODAJ TEREN</button>
            <button onclick="logout()" class="w-full py-4 bg-red-600/10 text-red-500 border border-red-500/20 rounded-2xl font-bold">Odjavi se</button>
        </div>

        <div id="menu-sports" class="hidden flex-grow space-y-3">
            <h3 class="text-xl font-bold mb-4">Izaberi sport:</h3>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectSport('‚öΩ', 'Fudbal')" class="p-4 bg-white/5 rounded-xl text-lg">‚öΩ Fudbal</button>
                <button onclick="selectSport('üèÄ', 'Kosarka')" class="p-4 bg-white/5 rounded-xl text-lg">üèÄ Ko≈°arka</button>
                <button onclick="selectSport('üèê', 'Odbojka')" class="p-4 bg-white/5 rounded-xl text-lg">üèê Odbojka</button>
                <button onclick="selectSport('ü§æ', 'Rukomet')" class="p-4 bg-white/5 rounded-xl text-lg">ü§æ Rukomet</button>
                <button onclick="selectSport('üéæ', 'Tenis')" class="p-4 bg-white/5 rounded-xl text-lg">üéæ Tenis</button>
            </div>
            <button onclick="resetMenu()" class="w-full mt-4 text-slate-400 italic">Nazad</button>
        </div>

        <div id="menu-name" class="hidden flex-grow space-y-4">
            <h3 id="selected-sport-title" class="text-xl font-bold"></h3>
            <input id="court-name" type="text" placeholder="Ime terena..." class="w-full p-5 bg-slate-800 rounded-2xl outline-none border border-blue-500/30">
            <button onclick="saveCourt()" class="w-full py-5 bg-green-600 rounded-2xl font-bold text-xl uppercase">Postavite teren</button>
            <button onclick="showSportSelect()" class="w-full text-slate-400 italic">Nazad</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyyqnqeS-9jurBX-6VIRp8CiPTMbXkXgw",
            authDomain: "allsportslocal-ea1d4.firebaseapp.com",
            databaseURL: "https://allsportslocal-ea1d4-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "allsportslocal-ea1d4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let map, userMarker, lastClickedLatLng;
        let selectedSportIcon, selectedSportName;

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([44.81, 20.46], 13);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}').addTo(map);

            L.Control.geocoder({ defaultMarkGeocode: false, collapsed: true, placeholder: "Pretra≈æi..." })
            .on('markgeocode', e => map.fitBounds(e.geocode.bbox)).addTo(map);

            // KLIK NA MAPU OTVARA JEZIƒåAK
            map.on('click', (e) => {
                lastClickedLatLng = e.latlng;
                toggleSidebar(true);
            });

            loadCourts();
            findMe();
        }

        // LOAD TERENA IZ BAZE
        function loadCourts() {
            onValue(ref(db, 'tereni'), (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                
                // Oƒçisti stare markere ako treba (u produkciji bi koristio LayerGroup)
                Object.values(data).forEach(court => {
                    const customIcon = L.divIcon({
                        className: 'court-marker',
                        html: `<div class="court-icon">${court.icon}</div><div class="court-label">${court.name}</div>`,
                        iconSize: [100, 30], iconAnchor: [15, 15]
                    });
                    L.marker([court.lat, court.lng], {icon: customIcon}).addTo(map);
                });
            });
        }

        // NAVIGATION MENIJA
        window.toggleSidebar = (open = null) => {
            const s = document.getElementById('sidebar');
            if (open === true) s.classList.remove('sidebar-closed');
            else if (open === false) s.classList.add('sidebar-closed');
            else s.classList.toggle('sidebar-closed');
            if (s.classList.contains('sidebar-closed')) resetMenu();
        };

        window.showSportSelect = () => {
            document.getElementById('menu-main').classList.add('hidden');
            document.getElementById('menu-sports').classList.remove('hidden');
            document.getElementById('menu-name').classList.add('hidden');
        };

        window.selectSport = (icon, name) => {
            selectedSportIcon = icon;
            selectedSportName = name;
            document.getElementById('selected-sport-title').innerText = icon + " " + name;
            document.getElementById('menu-sports').classList.add('hidden');
            document.getElementById('menu-name').classList.remove('hidden');
        };

        window.resetMenu = () => {
            document.getElementById('menu-main').classList.remove('hidden');
            document.getElementById('menu-sports').classList.add('hidden');
            document.getElementById('menu-name').classList.add('hidden');
        };

        window.saveCourt = async () => {
            const name = document.getElementById('court-name').value;
            if (!name) return alert("Unesite ime terena!");
            if (!lastClickedLatLng) return alert("Prvo kliknite na mapu gde ≈æelite teren!");

            const user = auth.currentUser;
            const newCourtRef = push(ref(db, 'tereni'));
            
            await set(newCourtRef, {
                name: name,
                icon: selectedSportIcon,
                sport: selectedSportName,
                lat: lastClickedLatLng.lat,
                lng: lastClickedLatLng.lng,
                owner: user.uid,
                ownerEmail: user.email
            });

            alert("Teren uspe≈°no postavljen!");
            document.getElementById('court-name').value = "";
            toggleSidebar(false);
        };

        window.findMe = () => {
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
            map.once('locationfound', (e) => {
                if (userMarker) map.removeLayer(userMarker);
                const pulseIcon = L.divIcon({ className: 'custom-div-icon', html: "<div class='pulse-marker'></div>", iconSize: [14, 14], iconAnchor: [7, 7] });
                userMarker = L.marker(e.latlng, {icon: pulseIcon}).addTo(map);
            });
        };

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Gre≈°ka pri prijavi"); }
        };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('map').style.display = 'block';
                document.getElementById('bottom-trigger').classList.remove('hidden');
                document.getElementById('gps-button').classList.remove('hidden');
                initMap();
                setTimeout(() => map.invalidateSize(), 400);
            } else {
                location.reload();
            }
        });
    </script>
</body>
</html>
