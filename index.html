<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HoodSport | Live Map</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background: #0f172a; touch-action: manipulation; }
        #map { height: 100vh; width: 100vw; display: none; }
        input { font-size: 16px !important; }

        /* SUPER SEARCH (NE MENJA SE) */
        .leaflet-control-geocoder {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15) !important;
            border-radius: 50px !important;
        }
        .leaflet-control-geocoder-form input { background: transparent !important; color: white !important; }
        .leaflet-control-geocoder-alternatives { background: white !important; color: black !important; border-radius: 12px; margin-top: 10px; }

        /* VIDLJIVIJI JEZIƒåAK */
        #bottom-trigger {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100px; height: 18px; background: rgba(59, 130, 246, 0.4);
            backdrop-filter: blur(8px); border-radius: 12px 12px 0 0; z-index: 2001;
            border: 1px solid rgba(255,255,255,0.2); border-bottom: none;
        }
        #bottom-trigger::after { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 35px; height: 4px; background: white; border-radius: 2px; }

        /* BOTTOM SHEET */
        #sidebar { 
            position: fixed; bottom: 0; left: 0; right: 0; height: 60vh;
            background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(25px);
            z-index: 2005; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-top: 1px solid rgba(255,255,255,0.1); border-radius: 30px 30px 0 0;
        }
        .sidebar-closed { transform: translateY(100%); }

        /* BRZO GPS DUGME */
        #gps-button {
            position: fixed; bottom: 35px; right: 20px; width: 55px; height: 55px;
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 18px; z-index: 2000;
        }

        /* PULS LOPTICA (TVOJA POZICIJA) */
        .pulse-marker { width: 14px; height: 14px; background: #3b82f6; border-radius: 50%; border: 2px solid white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }

        /* MARKER TERENA: LOPTICA + HORIZONTALNI TAB */
        .court-marker { display: flex; align-items: center; white-space: nowrap; }
        .court-icon-bg { 
            font-size: 18px; background: white; border-radius: 50%; width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 10;
        }
        .court-tab {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(8px); color: white;
            padding: 5px 15px 5px 22px; border-radius: 0 20px 20px 0; margin-left: -18px;
            font-weight: 600; font-size: 13px; border: 1px solid rgba(255,255,255,0.1); z-index: 5;
        }
    </style>
</head>
<body class="text-white">

    <div id="auth-screen" class="h-screen flex flex-col justify-center items-center px-6">
        <h1 class="text-5xl font-black text-blue-500 mb-8 italic tracking-tighter">HOODSPORT</h1>
        <div class="w-full max-w-sm space-y-4">
            <input id="email" type="email" placeholder="Email" class="w-full p-4 bg-slate-800 rounded-2xl outline-none">
            <input id="password" type="password" placeholder="Lozinka" class="w-full p-4 bg-slate-800 rounded-2xl outline-none">
            <button onclick="handleAuth()" class="w-full py-4 bg-blue-600 rounded-2xl font-bold uppercase tracking-widest">Uƒëi na mapu</button>
        </div>
    </div>

    <div id="map"></div>

    <button id="gps-button" class="hidden flex items-center justify-center" onclick="findMe()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
        </svg>
    </button>

    <button id="bottom-trigger" class="hidden" onclick="toggleSidebar()"></button>

    <div id="sidebar" class="sidebar-closed p-6 flex flex-col">
        <div class="w-16 h-1.5 bg-white/20 rounded-full mx-auto mb-6 cursor-pointer" onclick="toggleSidebar()"></div>
        
        <div id="step-main" class="flex-grow flex flex-col gap-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-3xl text-blue-500 italic">HoodSport</h2>
                <button onclick="toggleSidebar()" class="text-3xl text-slate-500">&times;</button>
            </div>
            <button onclick="goToStep('step-sports')" class="w-full py-6 bg-blue-600 rounded-2xl font-black text-xl shadow-lg shadow-blue-500/20">‚ûï DODAJ TEREN</button>
            <button onclick="logout()" class="w-full py-4 bg-red-600/10 text-red-500 border border-red-500/20 rounded-2xl font-bold mt-auto">Odjavi se</button>
        </div>

        <div id="step-sports" class="hidden flex-grow flex flex-col">
            <h3 class="text-xl font-bold mb-6">Izaberi sport:</h3>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="pickSport('‚öΩ', 'Fudbal')" class="p-5 bg-white/5 rounded-2xl text-lg flex items-center gap-3">‚öΩ Fudbal</button>
                <button onclick="pickSport('üèÄ', 'Kosarka')" class="p-5 bg-white/5 rounded-2xl text-lg flex items-center gap-3">üèÄ Ko≈°arka</button>
                <button onclick="pickSport('üèê', 'Odbojka')" class="p-5 bg-white/5 rounded-2xl text-lg flex items-center gap-3">üèê Odbojka</button>
                <button onclick="pickSport('ü§æ', 'Rukomet')" class="p-5 bg-white/5 rounded-2xl text-lg flex items-center gap-3">ü§æ Rukomet</button>
                <button onclick="pickSport('üéæ', 'Tenis')" class="p-5 bg-white/5 rounded-2xl text-lg flex items-center gap-3 col-span-2">üéæ Tenis</button>
            </div>
            <button onclick="goToStep('step-main')" class="mt-auto py-4 text-slate-400">Poni≈°ti</button>
        </div>

        <div id="step-confirm" class="hidden flex-grow flex flex-col gap-4">
            <h3 id="confirm-title" class="text-2xl font-bold text-blue-400"></h3>
            <p class="text-slate-400 text-sm">Upi≈°i naziv terena koji ƒáe biti vidljiv svima na mapi.</p>
            <input id="new-court-name" type="text" placeholder="Ime terena..." class="w-full p-5 bg-slate-800 rounded-2xl border border-blue-500/30 outline-none text-xl">
            <button onclick="finalSave()" class="w-full py-6 bg-green-600 rounded-2xl font-black text-xl shadow-lg shadow-green-500/20">POSTAVITE TEREN</button>
            <button onclick="goToStep('step-sports')" class="mt-auto py-4 text-slate-400">Nazad na sportove</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyyqnqeS-9jurBX-6VIRp8CiPTMbXkXgw",
            authDomain: "allsportslocal-ea1d4.firebaseapp.com",
            databaseURL: "https://allsportslocal-ea1d4-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "allsportslocal-ea1d4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let map, userMarker, clickLatLng;
        let selectedIcon, selectedSport;

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([44.81, 20.46], 13);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}').addTo(map);

            L.Control.geocoder({ defaultMarkGeocode: false, collapsed: true, placeholder: "Pretra≈æi..." })
            .on('markgeocode', e => map.fitBounds(e.geocode.bbox)).addTo(map);

            // KLIK NA MAPU -> OTVARA MENI
            map.on('click', (e) => {
                clickLatLng = e.latlng;
                toggleSidebar(true);
            });

            loadCourts();
            findMe();
        }

        // Prikaz svih terena iz baze
        function loadCourts() {
            onValue(ref(db, 'tereni'), (snap) => {
                const courts = snap.val();
                if (!courts) return;
                
                // Oƒçisti stare markere ako je potrebno (ovde dodajemo nove)
                Object.values(courts).forEach(c => {
                    const icon = L.divIcon({
                        className: 'court-marker',
                        html: `<div class="court-icon-bg">${c.icon}</div><div class="court-tab">${c.name}</div>`,
                        iconSize: [120, 32], iconAnchor: [16, 16]
                    });
                    L.marker([c.lat, c.lng], {icon: icon}).addTo(map);
                });
            });
        }

        window.toggleSidebar = (show) => {
            const s = document.getElementById('sidebar');
            if (show === true) s.classList.remove('sidebar-closed');
            else if (show === false) s.classList.add('sidebar-closed');
            else s.classList.toggle('sidebar-closed');
            if (s.classList.contains('sidebar-closed')) goToStep('step-main');
        };

        window.goToStep = (stepId) => {
            ['step-main', 'step-sports', 'step-confirm'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(stepId).classList.remove('hidden');
        };

        window.pickSport = (icon, name) => {
            selectedIcon = icon;
            selectedSport = name;
            document.getElementById('confirm-title').innerText = icon + " " + name;
            goToStep('step-confirm');
        };

        window.finalSave = async () => {
            const name = document.getElementById('new-court-name').value;
            if (!name) return alert("Upi≈°i ime!");
            if (!clickLatLng) return alert("Klikni na mapu prvo!");

            const user = auth.currentUser;
            const newRef = push(ref(db, 'tereni'));
            
            await set(newRef, {
                name: name,
                icon: selectedIcon,
                sport: selectedSport,
                lat: clickLatLng.lat,
                lng: clickLatLng.lng,
                owner: user.uid
            });

            document.getElementById('new-court-name').value = "";
            toggleSidebar(false);
            alert("Teren je na mapi!");
        };

        window.findMe = () => {
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
            map.once('locationfound', (e) => {
                if (userMarker) map.removeLayer(userMarker);
                const pulse = L.divIcon({ className: 'custom-div-icon', html: "<div class='pulse-marker'></div>", iconSize: [14, 14], iconAnchor: [7, 7] });
                userMarker = L.marker(e.latlng, {icon: pulse}).addTo(map);
            });
        };

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Gre≈°ka pri prijavi"); }
        };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('map').style.display = 'block';
                document.getElementById('bottom-trigger').classList.remove('hidden');
                document.getElementById('gps-button').classList.remove('hidden');
                initMap();
                setTimeout(() => map.invalidateSize(), 400);
            } else {
                location.reload();
            }
        });
    </script>
</body>
</html>
